name: Deploy Spring Boot to EC2

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # GitHub Actionsì—ì„œ ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build -x test --no-daemon
        timeout-minutes: 10

      # ë¹Œë“œ ê²°ê³¼ í™•ì¸
      - name: Check build artifacts
        run: |
          echo "=== Build artifacts ==="
          ls -la build/libs/
          echo "=== JAR file details ==="
          find build/libs -name "*.jar" -type f

      # ë¹Œë“œëœ JAR íŒŒì¼ì„ EC2ë¡œ ì „ì†¡ (ìµœì‹  ë²„ì „ + ê°œì„ ëœ ì„¤ì •)
      - name: Copy JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "build/libs/"
          target: "ecc-back/"
          strip_components: 0
          overwrite: true

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 300s
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to project directory
            cd ~/ecc-back
            
            # Pull latest code (docker-compose.yml ë“±ì„ ìœ„í•´)
            echo "ğŸ“¡ Pulling latest code..."
            git pull origin main
            
            # Load environment variables
            echo "ğŸ”§ Loading environment variables..."
            source ~/load-env.sh
            
            # ê°•ì œë¡œ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë° ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            echo "ğŸ›‘ Stopping and cleaning existing containers..."
            docker compose down || true
            docker stop $(docker ps -q) 2>/dev/null || true
            docker rm $(docker ps -aq) 2>/dev/null || true
            
            # 8080 í¬íŠ¸ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            echo "ğŸ”« Killing processes on port 8080..."
            sudo pkill -f "java.*8080" || true
            sudo fuser -k 8080/tcp || true
            
            # Docker ì‹œìŠ¤í…œ ì •ë¦¬ (ì´ë¯¸ì§€ëŠ” ìœ ì§€)
            echo "ğŸ§¹ Cleaning Docker system..."
            docker container prune -f
            docker volume prune -f
            
            # ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸
            echo "ğŸ’¾ Memory status before deployment:"
            free -h
            
            # ì „ì†¡ëœ íŒŒì¼ë“¤ í™•ì¸
            echo "ğŸ“ Checking transferred files..."
            ls -la ~/ecc-back/build/libs/ || echo "build/libs directory not found"
            
            # JAR íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸ (ê²½ë¡œ ìˆ˜ì •)
            if ls ~/ecc-back/build/libs/*.jar 1> /dev/null 2>&1; then
              echo "âœ… JAR file found"
              ls -la ~/ecc-back/build/libs/
            else
              echo "âŒ JAR file not found"
              echo "Current directory contents:"
              ls -la ~/ecc-back/
              exit 1
            fi
            
            # ë¹Œë“œ ì—†ì´ ì»¨í…Œì´ë„ˆ ì‹œì‘ (--build ì œê±°)
            echo "ğŸ³ Starting containers (no build)..."
            docker compose up -d
            
            # Wait for containers to start
            echo "â³ Waiting for containers to start..."
            sleep 30
            
            # Check container status
            echo "âœ… Checking container status..."
            docker compose ps
            
            # ë©”ëª¨ë¦¬ ìƒíƒœ ì¬í™•ì¸
            echo "ğŸ’¾ Memory status after deployment:"
            free -h
            
            # Docker stats í™•ì¸
            echo "ğŸ“Š Container resource usage:"
            timeout 10s docker stats --no-stream || true
            
            # API ìƒíƒœ í™•ì¸ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
            echo "ğŸ©º API ìƒíƒœ í™•ì¸ ì¤‘..."
            for i in {1..5}; do
              if curl -f -s http://localhost:8080/api/major; then
                echo "âœ… API ìƒíƒœ í™•ì¸ ì„±ê³µ (ì‹œë„ $i)"
                break
              else
                echo "â³ API ì¤€ë¹„ ì¤‘... (ì‹œë„ $i/5)"
                sleep 10
              fi
            done
            
            # ìµœì¢… í™•ì¸
            if curl -f -s http://localhost:8080/api/major >/dev/null; then
              echo "ğŸ‰ Deployment completed successfully!"
            else
              echo "âŒ Deployment completed but API is not responding"
              exit 1
            fi