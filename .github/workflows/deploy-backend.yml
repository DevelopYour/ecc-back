name: Deploy Spring Boot to EC2

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # GitHub Actionsì—ì„œ ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build -x test --no-daemon
        timeout-minutes: 10

      # ë¹Œë“œ ê²°ê³¼ í™•ì¸
      - name: Check build artifacts
        run: |
          echo "=== Build artifacts ==="
          ls -la build/libs/
          echo "=== JAR file details ==="
          find build/libs -name "*.jar" -type f -exec ls -lh {} \;
          echo "=== Total size ==="
          du -sh build/libs/

      # rsyncë¡œ JAR íŒŒì¼ì„ EC2ì— ì „ì†¡ (scpë³´ë‹¤ ì•ˆì •ì )
      - name: Deploy JAR to EC2 via rsync
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --progress --human-readable
          path: build/libs/
          remote_path: /home/ubuntu/ecc-back/build/libs/
          remote_host: ${{ secrets.EC2_HOST }}
          remote_user: ${{ secrets.EC2_USER }}
          remote_key: ${{ secrets.EC2_SSH_KEY }}
          remote_key_pass: ${{ secrets.EC2_SSH_KEY_PASSPHRASE || '' }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 900s
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to project directory
            cd ~/ecc-back
            
            # Pull latest code (docker-compose.yml ë“±ì„ ìœ„í•´)
            echo "ğŸ“¡ Pulling latest code..."
            git pull origin main
            
            # Load environment variables
            echo "ğŸ”§ Loading environment variables..."
            source ~/load-env.sh
            
            # ê°•ì œë¡œ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë° ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            echo "ğŸ›‘ Stopping and cleaning existing containers..."
            docker compose down || true
            docker stop $(docker ps -q) 2>/dev/null || true
            docker rm $(docker ps -aq) 2>/dev/null || true
            
            # 8080 í¬íŠ¸ ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            echo "ğŸ”« Killing processes on port 8080..."
            sudo pkill -f "java.*8080" || true
            sudo fuser -k 8080/tcp || true
            
            # Docker ì‹œìŠ¤í…œ ì •ë¦¬ (ì´ë¯¸ì§€ëŠ” ìœ ì§€)
            echo "ğŸ§¹ Cleaning Docker system..."
            docker container prune -f
            docker volume prune -f
            
            # ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸
            echo "ğŸ’¾ Memory status before deployment:"
            free -h
            
            # ì „ì†¡ëœ íŒŒì¼ë“¤ í™•ì¸
            echo "ğŸ“ Checking transferred files..."
            if [ -d ~/ecc-back/build/libs/ ]; then
              echo "âœ… build/libs directory found"
              ls -la ~/ecc-back/build/libs/
              echo "Directory size: $(du -sh ~/ecc-back/build/libs/)"
            else
              echo "âŒ build/libs directory not found"
              echo "Current ecc-back directory contents:"
              ls -la ~/ecc-back/
              exit 1
            fi
            
            # JAR íŒŒì¼ í™•ì¸ (ë” ì•ˆì „í•œ ë°©ë²•)
            echo "ğŸ” Verifying JAR files..."
            JAR_COUNT=$(find ~/ecc-back/build/libs/ -name "*.jar" -type f | wc -l)
            if [ "$JAR_COUNT" -gt 0 ]; then
              echo "âœ… Found $JAR_COUNT JAR file(s)"
              find ~/ecc-back/build/libs/ -name "*.jar" -type f -exec ls -lh {} \;
            
              # ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ ì°¾ê¸° (SNAPSHOT.jar, plainì´ ì•„ë‹Œ ê²ƒ)
              MAIN_JAR=$(find ~/ecc-back/build/libs/ -name "*SNAPSHOT.jar" -not -name "*plain.jar" -type f | head -1)
              if [ -n "$MAIN_JAR" ]; then
                echo "âœ… Main JAR file: $MAIN_JAR"
                echo "JAR size: $(ls -lh "$MAIN_JAR" | awk '{print $5}')"
              else
                echo "âš ï¸ Main JAR file not found, using any available JAR"
              fi
            else
              echo "âŒ No JAR files found"
              exit 1
            fi
            
            # ë¹Œë“œ ì—†ì´ ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "ğŸ³ Starting containers (using pre-built JAR)..."
            docker compose up -d
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            echo "â³ Waiting for containers to start..."
            sleep 45
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… Checking container status..."
            docker compose ps
            
            # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ì˜¤ë¥˜ ë””ë²„ê¹…ìš©)
            echo "ğŸ“‹ Checking Spring Boot container logs..."
            docker compose logs spring-app --tail=20
            
            # ë©”ëª¨ë¦¬ ìƒíƒœ ì¬í™•ì¸
            echo "ğŸ’¾ Memory status after deployment:"
            free -h
            
            # Docker stats í™•ì¸
            echo "ğŸ“Š Container resource usage:"
            timeout 15s docker stats --no-stream || true
            
            # API ìƒíƒœ í™•ì¸ (ë” ë§ì€ ì¬ì‹œë„)
            echo "ğŸ©º API ìƒíƒœ í™•ì¸ ì¤‘..."
            API_SUCCESS=false
            for i in {1..8}; do
              echo "Attempt $i/8: Testing API endpoint..."
              if curl -f -s -m 10 http://localhost:8080/api/major >/dev/null 2>&1; then
                echo "âœ… API ìƒíƒœ í™•ì¸ ì„±ê³µ (ì‹œë„ $i)"
                API_SUCCESS=true
                break
              else
                echo "â³ API ì¤€ë¹„ ì¤‘... (ì‹œë„ $i/8)"
                if [ $i -lt 8 ]; then
                  sleep 15
                fi
              fi
            done
            
            # ìµœì¢… í™•ì¸ ë° ê²°ê³¼
            if [ "$API_SUCCESS" = true ]; then
              echo "ğŸ‰ Deployment completed successfully!"
              echo "ğŸŒ API is responding at http://localhost:8080/api/major"
            else
              echo "âŒ Deployment completed but API is not responding"
              echo "ğŸ“‹ Container status for debugging:"
              docker compose ps
              echo "ğŸ“‹ Spring Boot logs for debugging:"
              docker compose logs spring-app --tail=50
              exit 1
            fi